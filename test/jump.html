<style>canvas { background: #eeeeee; }</style>
<p><canvas id="canvas" width="200" height="200"></p>
<div id="log" style="position:absolute;top:0;left:0;width:300px;height:500px;">
</div>
<script>

var ctx = document.getElementById("canvas").getContext("2d");

var player = {
        x:  100.0,
        y:  175.0,
        velocity: {
            x: 4.0,
            y: 0.0,
        },
        onGround: false
    };

var scene = {
        gravity: {
            x: 0.0,
            y: 0.5,
        }
    };

var JUMP_HIGH = -12.0; // ジャンプの最大値
var JUMP_LOW = -4.0;  // ジャンプの最小値

window.addEventListener("mousedown", startJump, false);
window.addEventListener("mouseup", endJump, false);


function startJump() {
    if (player.onGround) {
        player.onGround = false;
        player.velocity.y = JUMP_HIGH;
    }
}

function endJump() {
    if (player.velocity.y < JUMP_LOW) {
        player.velocity.y = JUMP_LOW;
    }
}

function loop() {
    input();
    update();
    render();
    requestAnimationFrame(loop);
}
loop();

var lastJumpButtonPressed = false;

function input() {
    if (padReady) {
      //var pad = availablePadList[0];
        var index = availablePadIndex[0];
        var pad = navigator.getGamepads()[index];

        if (pad && pad.connected) {
            var btn = pad.buttons;
            var axe = pad.axes;

            var div = document.querySelector("#log");
            div.innerHTML = Date.now() + "<br />";

            for (var i = 0, iz = btn.length; i < iz; ++i) {
                div.innerHTML += [i, btn[i].pressed, btn[i].value].join(",") + "<br />";
            }
            for (var i = 0, iz = axe.length; i < iz; ++i) {
                div.innerHTML += [i, axe[i]].join(",") + "<br />";
            }

            if (!lastJumpButtonPressed && btn[1].pressed) { // edge!
                lastJumpButtonPressed = true;
                startJump();
            } else if (lastJumpButtonPressed && !btn[1].pressed) { // edge!
                lastJumpButtonPressed = false;
                endJump();
            }
        }
    }
}

function update() {
    player.velocity.x += scene.gravity.x; // 重力方向に速度を加速
    player.velocity.y += scene.gravity.y; // 重力方向に速度を加速
    player.y += player.velocity.y;        // 座標に速度を加算
    player.x += player.velocity.x;        // 座標に速度を加算

    if (player.y > 175.0) {
        player.y = 175.0;
        player.velocity.y = 0.0;
        player.onGround = true;
    }
    if (player.x < 10 || player.x > 190) {
        player.velocity.x *= -1;
    }
}

function render() {
    ctx.clearRect(0, 0, 200, 200);
    ctx.beginPath();
    ctx.moveTo(0,175);
    ctx.lineTo(200,175);
    ctx.stroke();
    ctx.strokeRect(player.x - 10, player.y - 20, 20, 20);
}

var padReady = false;
var availablePadList = [];
var availablePadIndex = [];

/*
if (navigator.getGamepads) {
    var tid = setInterval(function() {
        var list = [].slice.call(navigator.getGamepads());

debugger;
        availablePadList = list.filter(function(pad) { return !!pad; });

        if (availablePadList.length) {
debugger;
            padReady = true;
            clearInterval(tid);
        }
    }, 100);
}
 */

window.addEventListener("gamepadconnected",function(event) {
    console.log("gamepadconnected");
    //availablePadList.push( event.gamepad );
    availablePadIndex.push(event.gamepad.index);

    console.log("gamepad.id", event.gamepad.id);
    console.log("gamepad.index", event.gamepad.index);
    console.log("gamepad.connected", event.gamepad.connected);
    console.log("gamepad.mapping", event.gamepad.mapping);
    console.log("gamepad.buttons.length", event.gamepad.buttons.length);
    console.log("gamepad.axes.length", event.gamepad.axes.length);

    padReady = true;
});

window.addEventListener("gamepaddisconnected",function(event) {
    console.log("gamepaddisconnected");
    //availablePadList = [];
    availablePadIndex = availablePadIndex.filter(function(value) {
        return event.gamepad.index !== value;
    });
    padReady = false;
});



</script>

